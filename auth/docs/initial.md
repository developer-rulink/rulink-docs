# Первоначальная настройка сервера

Сервис поставляется в виде Docker-контейнера. Ниже приведены шаги для первоначальной настройки сервиса аутентификации.

!!! tip "Highloads"
    Если число пользователей больше 500, рекомендуется использовать сервис на выделенных ресурсах.

## Ввод сервиса в эксплуатацию

## Что необходимо для начала работы

!!! info
    Сервис **Identity** и другие сервисы Облакотех должны быть в одном домене — это важно для работы механизма cookies.

1. Доменное имя для сервиса Identity
2. Доступный сервис баз данных **PostgreSQL 17+**
    2.1. Созданная база данных
    2.2. Учётные данные пользователя с доступом к базе данных
    2.3. Пользователь базы данных должен иметь права на создание таблиц и индексов
3. Доступ к сервисам **Identity** предоставляется по **https**
    3.1. Рекомендуется использовать **wildcard-сертификат** для вашего домена
    3.2. Сервис может сгенерировать самоподписанные сертификаты для вашего домена
    3.3. Инструкция по настройке TLS-сертификатов приведена ниже
4. Docker-образ сервиса.

## Настройка сервиса

### Шаг 1. Сгенерируйте ключи для подписи JWT

Для аутентификации пользователей используется JWT-токен. JWT-токен содержит данные о пользователе и подписан ключом издателя (сервиса Identity).
Для начала работы необходимо сгенерировать открытый и закрытый ключи. Закрытый ключ будет храниться в сервисе Identity, открытый ключ необходимо предоставить другим сервисам, которые интегрированы с Identity.

Для генерации ключей запустите скрипт `generate-jwt-keypair.sh`.

``` bash
sudo bash -c /opt/services/z-config/generate-jwt-keypair.sh
```

В результате будут сгенерированы открытый и закрытый ключи. Ключи сохранятся в каталоге `/opt/services/z-config/identity/resources/.rulink`.

### Шаг 2. Заполните настройки сервиса

Укажите настройки сервиса:

- параметры подключения к базе данных
- параметры для формирования JWT и cookies

Параметры сервиса задаются в файле `/opt/services/z-config/rulink-compose/.env`

``` yaml
# Common Database configuration
IDENTITY_DB_HOST=_YOUR_DB_SERVER_       # 192.168.1.96
IDENTITY_DB_PORT=_YOUR_DB_SERVER_PORT_  # 5432
IDENTITY_DB_NAME=_YOUR_DB_NAME_         # otech_services
IDENTITY_DB_USER=_YOUR_DB_USER_         # otechuser
IDENTITY_DB_PASSWORD=_YOUR_DB_USER_PASSWORD_ # 9r0Mw2yHPx7L5i8HYbdqZsD

# Identity service configuration
IDENTITY_SERVICEURL=_YOUR_SERVICE_URL_ # https://identity.mycompany.ru
IDENTITY_DOMAIN=_YOUR_DOMAIN_NAME_     # mycompany.ru
IDENTITY_AUDIENCE=_YOUR_COMPANY_NAME_  # mycompany
IDENTITY_SKIP_FINGERPRINT=true
IDENTITY_ALLOW_LOCAL_USERS=false
IDENTITY_LOCALADMIN_PWD=_YOUR_PASSWORD_ # 99qi@T653R!6wY
```

!!! tip "Пароли и секреты"
    В этой конфигурации пароли хранятся в переменных docker compose. Если ваша организация использует специализированные сервисы для хранения секретов — используйте их.

Параметры сервиса:

- **IDENTITY_SERVICEURL** — адрес, по которому сервис будет доступен в вашей организации. Используется для отображения параметров интеграции.
- **IDENTITY_DOMAIN** — домен, для которого будет формироваться cookie.
- **IDENTITY_AUDIENCE** — аудитория, для которой будет сформирован JWT. Обычно — название компании.
- **IDENTITY_SKIP_FINGERPRINT** — отключение усиленной проверки JWT. Если удалить параметр, усиленная проверка включится. Рекомендуется `IDENTITY_SKIP_FINGERPRINT=true`.
- **IDENTITY_ALLOW_LOCAL_USERS** — разрешение на вход для локального пользователя. Включать только для первого запуска и настройки. После завершения настройки **крайне рекомендуется** установить `IDENTITY_ALLOW_LOCAL_USERS=false`.
- **IDENTITY_LOCALADMIN_PWD** — пароль первого пользователя. Указывать только для первого запуска. После завершения настройки **крайне рекомендуется удалить эту переменную**.

### Шаг 3. Настройка сертификатов

Сервисы публикуются по протоколу **https**. Для шифрования передачи данных необходимо иметь сертификат.
Подробнее о настройке сертификатов: [Настройка SSL-сертификатов](https://rulink.io/support/system/ssl/)

### Шаг 4. Настройка шлюза приложений nginx

Публикация сервисов для доступа пользователей осуществляется с помощью **nginx**.
Подробнее о настройке публикации сервисов: [Публикация сервисов в Nginx](https://rulink.io/support/system/nginx/)

### Шаг 5. Запуск сервиса

Выполните скрипт обновления настроек сервиса:
`update-identity.sh` — для обновления конфигурации сервиса Identity

``` bash
sudo bash -c /opt/services/z-config/update-identity.sh
```

Выполните скрипт для запуска `docker compose` с новыми переменными:
`update-compose.sh` — для перезапуска сервисов с новыми переменными окружения

``` bash
sudo bash -c /opt/services/z-config/update-compose.sh
```

### Шаг 6. Проверка работы сервисов

Используйте браузер для доступа к сервисам.
Перейдите по доменному имени сервиса **Identity** в браузере. Сервис должен автоматически переключиться на протокол `https`.
Будет открыта страница `/auth/login` с формой ввода логина и пароля. Введите логин и пароль — после успешной авторизации будет выполнен автоматический переход на страницу `/auth/account` с данными профиля пользователя.

## Первый запуск сервиса и локальный пользователь

При первом запуске в базе данных сервиса нет пользователей, поэтому необходимо использовать локального пользователя для подключения к сервису.

Проверьте, что переменные запуска сервиса установлены в следующее значение.
Расположение файла: `/opt/services/z-config/rulink-compose/.env`

``` yaml
IDENTITY_ALLOW_LOCAL_USERS=true         # true - для возможности входа пользователем admin@local
IDENTITY_LOCALADMIN_PWD=_YOUR_PASSWORD_ # 99qi@T653R!6wY
```

Выполните скрипт для запуска `docker compose` с новыми переменными:
`update-compose.sh` — для перезапуска сервисов с новыми переменными окружения

``` bash
sudo bash -c /opt/services/z-config/update-compose.sh
```

Перейдите по доменному имени сервиса **Identity** в браузере. Сервис должен автоматически переключиться на протокол `https`. В форме логина введите:
`login = admin@local`, `password` — ваш пароль из переменной `IDENTITY_LOCALADMIN_PWD`.
При успешном входе откроется страница настроек пользователя.

Нажмите кнопку **Управление**, чтобы перейти в раздел управления пользователями и группами.

<figure markdown="span">
  ![Переход в раздел управления](https://rulink.io/images/auth-start-01.png){ width="500" }
  <figcaption>Переход в раздел управления</figcaption>
</figure>

В разделе **Пользователи** нажмите кнопку **Добавить** для создания нового пользователя.

<figure markdown="span">
  ![Добавление нового пользователя](https://rulink.io/images/auth-start-02.png){ width="500" }
  <figcaption>Добавление нового пользователя</figcaption>
</figure>

В форме создания нового пользователя укажите **Группу** (сейчас доступна только одна группа — её название совпадает с тем, что вы ранее указали в настройке `IDENTITY_AUDIENCE`).
В поле **Электронная почта пользователя** укажите электронную почту администратора системы (адрес должен быть действительным).
В поле **Пароль** укажите пароль пользователя. Пароль не может быть короче 7 символов. Рекомендуется использовать сложные пароли с буквами разного регистра, цифрами и символами.
Нажмите кнопку **Создать**.

Новый пользователь будет создан и отображён в списке пользователей.
Нажмите на нового пользователя в списке — откроется анкета пользователя.

В анкете найдите разделы **Группы пользователя** и **Роли пользователя**.
Проверьте, что в разделе **Группы пользователя** выбрана группа вашей организации (звёздочка синего цвета).
Добавьте роль **admin** пользователю — для этого нажмите на звёздочку справа от роли admin.

<figure markdown="span">
  ![Настройки пользователя](https://rulink.io/images/auth-start-03.png){ width="500" }
  <figcaption>Настройки пользователя</figcaption>
</figure>

Проверьте возможность входа под новым пользователем. Перейдите в раздел **Управление** и попробуйте создать нового пользователя. Если это удалось — у вас есть права администратора и пользователь работает.

Откройте файл настроек, отключите вход локального пользователя и удалите пароль для локального администратора.
Расположение файла: `/opt/services/z-config/rulink-compose/.env`

``` yaml
IDENTITY_ALLOW_LOCAL_USERS=false         # false - для запрета на вход пользователем admin@local
IDENTITY_LOCALADMIN_PWD=_YOUR_PASSWORD_  # <--- ЗАПОМНИТЕ И УДАЛИТЕ ЭТУ ПЕРЕМЕННУЮ
```

Выполните скрипт для запуска `docker compose` с новыми переменными:
`update-compose.sh` — для перезапуска сервисов с новыми переменными окружения

``` bash
sudo bash -c /opt/services/z-config/update-compose.sh
```

Продолжите работу под новым пользователем с ролью администратора.

## Рекомендации по безопасности

1. Если сервис используется только внутри корпоративной сети, рекомендуется ограничить доступ к сервису по IP-адресу.
2. Всегда используйте TLS (HTTPS) для защиты данных при передаче.
3. Ограничьте доступ к файлам конфигурации и ключам только для необходимых пользователей.
4. Настройте регулярное резервное копирование базы данных и файлов конфигурации.
5. Ограничьте опубликованные порты на сервере только теми, которые необходимы для работы сервиса.

## В случае ошибки

Проверить работу сервисов можно в лог-файлах.
Лог-файлы хранятся в каталоге сервиса `/opt/services/{SERVICENAME}/logs`. Каждый файл хранит логи работы сервиса за одни сутки.

Если настроить сервис самостоятельно не удалось — обратитесь в нашу службу поддержки [support@rulink.io](mailto:support@rulink.io).
