# Первоначальная настройка сервера

Сервис поставляется в виде Docker контейнера. Ниже приведены шаги для первоначальной настройки сервиса аутентификации.

!!! tip "Highloads"  
    Если число пользователей больше 500, рекомендуется использовать сервис на выделенных ресурсах.

## Ввод сервиса в эксплуатацию

## Что необходимо для начала работы

!!! info  
    Сервис **Identity** и другие сервисы ОблакоТех должны быть в одном домене, это важно для работы механизма cookies

1. Доменное имя для сервиса Identity
2. Доступный сервис баз данных **PostgreSQL 17+**  
    2.1. Созданная база данных  
    2.2. Учетные данные пользователя с доступом к базе данных  
3. Доступ к сервисам **Identity** предоставляется по **https**  
    3.1. Рекомендуется использовать **wildcard сертификат** для вашего домена  
    3.2. Сервис может сгенерировать самоподписанные сертификаты для вашего домена  
    3.3. Инструкция по настройке TLS сертификатов ниже

## Настройка сервиса

### Шаг 1. Сгенерируйте ключи для подписи JWT

### Шаг 2. Заполните параметры запуска

### Шаг 3. Настройка сертификатов

### Шаг 4. Настройка шлюза приложений nginx

### Шаг 5. Запуск сервиса

### Шаг 6. Проверка работы сервисов

## Проверьте доступность сервиса

## Первый запуск сервиса и локальный пользователь



Сервис аутентификации использует СУБД PostgreSQL.  

- [x] Убедитесь, что у вас есть доступ к серверу PostgreSQL  

Создайте пользователя и базу данных для сервиса аутентификации. Получите следующие данные:

- IP адрес и порт сервера PostgreSQL  
- Имя базы данных  
- Имя пользователя базы данных  
- Пароль пользователя базы данных  
- Убедитесь, что сервер PostgreSQL доступен с сервера, на котором будет работать сервис аутентификации  

Если у вас нет сервера PostgreSQL, вы можете установить его на том же сервере, что и сервис аутентификации (рекомендуется), или использовать облачный сервис PostgreSQL  

!!! note "Важно"
    Пользователь баз данных должен иметь права на создание таблиц и индексов в базе данных.

### Настройте DNS и доменное имя

Убедитесь, что доменное имя, которое вы планируете использовать для доступа к сервису аутентификации, правильно настроено и указывает на IP адрес сервера.  

### Проверьте доступ к серверу и права пользователя
- Убедитесь, что у вас есть доступ к серверу с правами администратора  
- Убедитесь, что у вас есть права на создание и изменение файлов в папке `/opt`
- Убедитесь, что у вас есть права на выполнение команд с `sudo`
- Убедитесь, что у вас есть права на выполнение команд Docker с `sudo`

### Сгенерируйте SSL сертификат или получите его у доверенного центра сертификации
Выпустите SSL сертификат для доменного имени, самоподписанный или от доверенного центра сертификации (рекомендуется).  
Если вам требуется помощь в настройке — обратитесь в [поддержку](https://rulink.io/support).

Необходимо 2 файла:

- Приватный ключ SSL сертификата  
- Сертификат SSL  

Сохраните файлы в папку `/opt/ssl/` на сервере, где будет работать сервис аутентификации.

### Сгенерируйте ключи шифрования JWT
Ключи шифрования используются для подписи и проверки JWT токенов.  
Для генерации ключей шифрования рекомендуется использовать скрипт, поставляемый вместе с сервисом аутентификации:  
`/opt/services/updates/identity-generate-jwt-keys.sh`

1. Установите OpenSSL, если он еще не установлен:
```bash
sudo apt-get install openssl
```
2. Запустите скрипт
```bash
sudo bash /opt/services/updates/identity-generate-jwt-keys.sh
```

Вы должны увидеть что-то подобное:
``` bash
.......... ...
+++++
writing RSA key
total 16
-rw-rw-r-- 1 user user  701 Sep  6 02:10 appsettings.json
-rw------- 1 user user 1704 Sep  8 00:38 jwt_private.key
-rw-r--r-- 1 user user  451 Sep  8 00:38 jwt_public.key
-rw-rw-r-- 1 user user 1001 Sep  5 01:48 Nlog.config
```
3. Скопируйте файлы `jwt_private.key` и `jwt_public.key` в папку `/opt/services/updates/static/identity/resources/` на сервере, где будет работать сервис аутентификации.

### Актуализируйте файл настроек сервиса
Откройте файл `/opt/services/updates/static/identity/resources/appsettings.json` и внесите необходимые изменения:

- В разделе `ConnectionStrings:PostgresServerConnection` укажите параметры подключения к базе данных  
- В разделе `Auth:Url` укажите URL, по которому будет доступен сервис аутентификации (например, `https://auth.your-domain.com`)  
- В разделе `Auth:Jwt:Audience` укажите название вашей организации латиницей

Другие параметры оставьте по умолчанию.
```json
{
  ...
  "ConnectionStrings": {
    "PostgresServerConnection": "Host=your_server:your_port;Database=your_db;Username=your_user;Password=your_password"
  },
  "Auth": {
    "Url": "your_auth_url",
    "Jwt": {
      "PrivateKeyPath": "/opt/resources/jwt_private.key",
      "PublicKeyPath": "/opt/resources/jwt_public.key",
      "Audience": "your_company_name"
    },
    "DataProtectionPersistentKey": "/opt/resources/keys"
  },
  ...
}
```
 
### Запустите сервис аутентификации
Запустите скрипт для настройки и запуска сервиса аутентификации:
```bash
sudo bash /opt/services/updates/update-identity.sh
```
После выполнения команды, сервис аутентификации будет запущен и готов к использованию.

??? question "Что происходит при запуске скрипта"
    1. Создаются папки для работы сервиса + устанавливаются права доступа  
    2. Копируются файлы конфигурации и ключи в рабочую папку сервиса
    3. Настраивается автоматический запуск сервиса при загрузке системы  
    4. Запускается сервис

### Проверить работоспособность сервиса
После запуска сервиса, проверьте его статус:
```bash
sudo systemctl status identityservice
```
Вы должны увидеть что-то подобное:
``` bash
● identityservice.service - IdentityService
     Loaded: loaded (/etc/systemd/system/identityservice.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2023-09-11 012:34:56 UTC; 1min 30s ago
     Main PID: 12345 (dotnet)
     Tasks: 10 (limit: 4915)
     Memory: 50.0M
``` 

Проверьте доступность API сервиса:
```bash
curl -k https://your_auth_url/api/auth/v1/heartbeat
"Server Ok\nVersion:0.1.1"
```

Откройте страницу `https://your_auth_url/heartbeat` в браузере.

### Выполните первый вход с локальным пользователем
Откройте страницу `https://your_auth_url/auth/login` в браузере.

В форма входа введите логин и пароль локального пользователя.  
Эти данные должны быть предоставлены вам при создании сервиса аутентификации.
Если вы не знаете логин и пароль локального пользователя - [обратитесь в поддержку](https://rulink.io/support).

- [x] Создайте нового пользователя с вашей электронной почтой и паролем
- [x] Добавьте новому пользователю роль `admin` для управления сервисом аутентификации
- [x] Выйдите из системы и войдите снова, используя данные нового пользователя
- [x] Смените пароль локального пользователя и сохраните его в надежном месте
- [x] Убедитесь, что вы можете войти в систему локальным пользователем с новым паролем

Измените файл конфигурации `/opt/services/updates/static/identity/appsettings.json`, установив параметр `ServerSecurity:AllowLocalUsers` в `false`, чтобы отключить возможность входа локальных пользователей.

```json
{
  ...
  "ServerSecurity": {
    "AllowLocalUsers": false
  },
  ...
}
```
Сохраните файл `appsettings.json` и перезапустите сервис аутентификации с помощью скрипта обновлений:
```bash
sudo bash /opt/services/updates/update-identity.sh
```

??? question "Что происходит при запуске скрипта"
    1. Создаются папки для работы сервиса + устанавливаются права доступа  
    2. Копируются файлы конфигурации и ключи в рабочую папку сервиса
    3. Настраивается автоматический запуск сервиса при загрузке системы  
    4. Запускается сервис

## Рекомендации по безопасности
1. Если сервис используется только внутри корпоративной сети, рекомендуется ограничить доступ к сервису по IP адресу.
2. Всегда используйте TLS (HTTPS) для защиты данных при передаче.
3. Ограничьте доступ к файлам конфигурации и ключам только для необходимых пользователей.
4. Настройте регулярное резервное копирование базы данных и файлов конфигурации.
5. Ограничьте опубликованные порты на сервере только необходимыми для работы сервиса.


----
## OLD

2. Проверьте, что доменное имя, которое вы планируете использовать для доступа к сервису, правильно настроено и указывает на IP адрес сервера.
3. Убедитесь, что у вас есть доступ к серверу с правами администратора
4. Перезагрузите сервер, чтобы убедиться, что все обновления установлены и система работает корректно
5. Если требуется помощь в настройке — обратитесь в [поддержку](https://rulink.io/support)  