# SSL сертификаты

SSL-сертификат обеспечивает шифрование данных между браузером пользователя и сервером. Без него браузеры помечают сайт как небезопасный, а современные API недоступны без HTTPS. Для корректной работы сервисов Облакотех SSL-сертификат обязателен.

## Wildcard-сертификат от авторизованного центра

Wildcard-сертификат (`*.example.ru`) покрывает все поддомены одного уровня и позволяет не выпускать отдельный сертификат для каждого сервиса. Такой сертификат выпускается авторизованным удостоверяющим центром (УЦ) — организацией, которая проверяет владение доменом и подписывает сертификат своим корневым ключом. Браузеры и операционные системы доверяют цепочке от таких УЦ автоматически, без каких-либо дополнительных настроек на стороне пользователя.

Найти провайдеров можно по ключевым словам **заказать wildcard ssl сертификат россия**.
Услуга стоит около 5000 рублей за годовой сертификат.

!!! info "Почему необходим wildcard-сертификат"
    Любой сервис Облакотех работает в паре с сервисом **Identity**, и все сервисы должны работать в одном домене. Поэтому наилучшим решением будет применение wildcard-сертификата.

### Настройка

1. Сохраните файлы сертификата и закрытого ключа в каталог `/opt/ssl`.  
2. Создайте конфигурационный файл со ссылкой на сертификаты в конфигурации **nginx**  
    - Создайте файл `/etc/nginx/snippets/ssl-mydomain.conf`
    - Добавьте в файл `/etc/nginx/snippets/ssl-mydomain.conf` путь к файлам ssl

    ``` yaml
    ssl_certificate /opt/ssl/{your_file_name}.crt;
    ssl_certificate_key /opt/ssl/{your_file_name}.key;
    ```

3. Проверьте конфигурацию **nginx**

``` bash
sudo nginx -t
```

4. Перезапустите **nginx**

``` bash
sudo service nginx restart
```

## Как создать и настроить самоподписанный сертификат

Вы можете самостоятельно сгенерировать сертификат.  
Для каждого публикуемого сервиса необходимо сгенерировать собственный ssl сертификат.

Для генерации сертификата выполните скрипт `generate-selfsigned-ssl.sh` с указанием доменного имени сервиса

``` bash
sudo bash -c /opt/services/z-config/generate-selfsigned-ssl.sh _ДОМЕННОЕ_ИМЯ_
```

Например:

``` bash
sudo bash -c /opt/services/z-config/generate-selfsigned-ssl.sh crypto.oblakotech.ru
```

!!! info "Что делает скрипт"
    1. Генерирует открытый и закрытый ключ  
    Файлы сертификата будут сохранены в директории `/opt/ssl/`:  
        - `/opt/ssl/{your_domain_name}.crt` - открытый ключ
        - `/opt/ssl/{your_domain_name}.key` - закрытый ключ  
    2. Добавляет ссылку на ключи в конфигурацию **nginx**  
        `/etc/nginx/snippets/ssl-{your_domain_name}.conf`  
    3. Устанавливает разрешения на файлы и папку `/opt/ssl/`

### Поведение браузера при работе с самоподписанными сертификатами

Самоподписанный сертификат не привязан к доверенному УЦ, поэтому браузер не может автоматически проверить его подлинность. При первом открытии сайта браузер отображает предупреждение «Ваше подключение не является приватным» (или аналогичное). Чтобы продолжить, пользователь должен явно подтвердить исключение безопасности.

!!! warning "Предупреждение"
    Самоподписанные сертификаты подходят только для тестовых и внутренних сред. Не используйте их в производственных системах, доступных конечным пользователям.

## Настройка публикации сервиса

Каждый сервис публикуется через отдельный конфигурационный файл **nginx**

Для всех публикуемых сервисов, выполните следующее:

1. Отредактируйте файл `/opt/services/z-config/nginx_sites/{service}`
2. Укажите корректное доменное имя для публикации сервиса (в двух местах)
3. Укажите корректный файл конфигурации ssl для сервиса
    - Для wildcard-сертификатов авторизованного центра: см. Настройка, Шаг 2.
    - Для самоподписанных сертификатов: см. "Что делает скрипт", Пункт 2.

пример файла:

``` yaml
server {
        listen 443 ssl;
        server_name light-edo.pbank.ru;          # <--- АКТУАЛЬНОЕ ДОМЕННОЕ ИМЯ
        include snippets/wildcard-pbank.ru.conf; # <--- ФАЙЛ КОНФИГУРАЦИИ SSL
        ...
}

server {
        listen 80;
        server_name light-edo.pbank.ru;          # <--- АКТУАЛЬНОЕ ДОМЕННОЕ ИМЯ
        return 301 https://$server_name$request_uri;
}
```

После того, как все файлы в `nginx_sites` будут актуализированы, выполните скрипт:

``` bash
sudo bash -c /opt/services/z-config/update-nginx.sh
```

Проверьте доступность сервиса в браузере.
