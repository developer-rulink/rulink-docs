# Запуск сервиса из Marketplace Yandex Cloud

Вы можете запустить собственную инсталяцию сервиса из Маркетплейса Яндекс Облака.  
Страница сервиса на маркетплейсе тут:  
[xxx](xxx)

!!! info  
    Время получения и настройки сервиса из Маркетплейса займет около 13 минут

## Что необходимо для начала работы

!!! info  
    Сервис Identity и сервис Crypto должны быть в одном домене, это важно для работы механизма cookies

1. Доменное имя для сервиса Identity (если у вас уже есть Identity сервис от других продуктов Облакотех - можно использовать его)  
2. Доменное имя для сервиса работы с электронной подписью
3. Доступный сервис баз данных **PostgreSQL 17+**  
    3.1. Созданная база данных  
    3.2. Учетные данные пользователя с доступом к базе данных  
    3.3. У пользователя должны быть права `write`, `right` (?)
4. Доступный сервис **объектного хранилища S3**  
    4.1. Доступ к `aws_bucket`  
    4.2. Ключи доступа к `bucket`
5. Доступ к сервисам **Identity** и **CryptoService** предоставляется по **https**  
    5.1. Рекомендуется использовать **wildcard сертификат** для вашего домена  
    5.2. Сервис может сгенерировать самоподписанные сертификаты для вашего домена  
    5.3. Инструкция по настройке TLS сертификатов ниже

!!! info  
    Инстанс PostgreSQL может быть создан в Яндекс Облаке. Инструкция тут: [xxx](xxx)  
    Инстанс S3 может быть создан в Яндекс Облаке. Инструкция тут: [xxx](xxx)

## Установка и настройка

### Шаг 1. Запустите сервис из маркетплейса Яндекс Облака

#### Конфигурация и сайзинг

### Шаг 2. Настройка сервиса Identity

Если у вас нет настроенного сервиса Identity выполните этот шаг.  
Если у вас есть настроенный сервис Identity используйте настройки подключения, существующего сервиса (см. раздел `Интеграция с сервисом Identity`).  

#### Интеграция с сервисом Identity

Описание интеграции с сервисом Identity представлено тут: [xxx](xxx)

### Шаг 3. Настройка сервиса CryptoService

Все пользовательские параметры запуска сервиса хранятся в compose.yaml файле.  
Путь к файлу `/opt/services/z-config/rulink-compose/.env`

#### 3.1. Интеграция с Identity

Скопируйте файл публичного ключа подписи для JWT.  
Получите файл `jwt_public.key` и сохраните его в директорию  
`/opt/services/z-config/cryptoservice/resources/.rulink/`

ПРИМЕР содержимого файла

``` bash
-----BEGIN PUBLIC KEY-----
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
XXXXXXXXXXXXXXXXDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD
QQQQQQQWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW
SSSSSSXCDF
-----END PUBLIC KEY-----
```

Укажите параметры работы Identity сервиса. Для этого заполните параметры запуска в compose.yaml файле.  
Путь к файлу `/opt/services/z-config/rulink-compose/.env`

Укажите переменные:

``` yaml
# Identity service configuration
IDENTITY_SERVICEURL=_URL_ВАШЕГО_IDENTITY_СЕРВИСА       #Например: https://identity-demo.oblakotech.ru
IDENTITY_DOMAIN=_ДОМЕН_В_КОТОРОМ_РАБОТАЮТ_ВАШ_СЕРВИС_  #Например: oblakotech.ru
IDENTITY_AUDIENCE=_НАЗВАНИЕ_КОМПАНИИ                   #Например: oblakotech Рекомендуется как домен
IDENTITY_SKIP_FINGERPRINT=true                         #Например: идентификация с дополнительным фактором защиты. Должно быть как у сервиса Identity
```

!!! info  
    Переменные интеграции с сервисов Identity должны быть такие же, как у сервиса Identity.  
    Если оба сервиса работают в одном docker compose этот блок переменных будет общий для обоих сервисов.  
    По умолчанию, оба сервиса работают в одном docker compose. Если у вас другая конфигурация и вам требуется помощь - обратитесь в нашу поддержку [support@rulink.io](mailto:support@rulink.io).

#### 3.2. Настройка сервиса Crypto

Для работы сервис использует:

- Базу данных
- Объектное хранилище

Переменные для подключения базы данных к сервису

``` yaml
CS_DB_HOST=_DB_SERVERNAME_
CS_DB_PORT=_DB_SERVICEPORT_
CS_DB_NAME=_DB_NAME_
CS_DB_USER=_DB_USER_
CS_DB_PASSWORD=_DB_USERPASSWORD_
```

База данных должна быть создана.  
Пользователь DB_USER должен иметь права:

- LOGIN
- CONNECT ON DATABASE
- USAGE, CREATE ON SCHEMA

!!! warning  
    Рекомендуется назначать пользователю минимальные права (избегайте ролей SUPERUSER, CREATEDB, CREATEROLE, избегайте прав pg_read_all_data / pg_write_all_data)

Укажите переменные для подключения в объектному хранилищу S3.  
Переменные для подключения хранилища к сервису

``` yaml
S3_ENDPOINT=http://localhost:9000
S3_BUCKET_NAME=_YOUR_BUCKET_NAME_
AWS_ACCESS_KEY_ID=_YOUR_ACCESSKEY_
AWS_SECRET_ACCESS_KEY=_YOUR_SECRET_KEY_
#S3_REGION=ru-center-b  #Укажите, если поддерживает ваш провайдер
```

!!! warning  
    Используйте объектное хранилище только с авторизацией

### Шаг 4. Настройка сертификатов

!!! note
    Для лучшего пользовательского опыта рекомендуется использовать сертификаты от авторизованных центров сертификации.

Подробная инструкция для настройки wildcard сертификатов тут: [xxx](xxx)
Подробная инструкция для создания и настройки самоподписанных сертификатов тут: [xxx](xxx)

### Шаг 5. Настройка шлюза приложений nginx

Подробная инструкция по настройке публикации приложения тут: [xxx](xxx)

Необходимо настроить публикацию сервиса Identity.  Используйте `доменное имя` и `ssl.conf` предназначенные для сервиса.  
Если у вас уже есть работающий сервис Identity можно использовать его. В этом случает пропустите публикацию Idetity из текущей поставки.

Необходимо настроить публикацию сервиса Crypto. Используйте `доменное имя` и `ssl.conf` предназначенные для сервиса.

### Шаг 6. Запуск сервисов

Если вы используете сервис Identity из другой поставки - отключите этот сервис в текущей поставке (см. Настройка Identity).

Выполните скрипт обновления для всех настроенных сервисов. `update-crypto.sh`
Выполните скрипт `update-compose.sh`

``` bash
sudo bash -c /opt/services/z-config/update-compose.sh
```

Если все сконфигурированно правильно, то вывод будет примерно такой
``` bash

```

## Компоненты сервиса

1. ubuntu 24.04+ LTS  
2. nginx 1.24.0+  
3. docker 24+  
4. identity service oblakotech
5. crypto service oblakotech

